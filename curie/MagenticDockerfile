# Base image with Python and Conda
FROM continuumio/miniconda3:latest

ARG PROMPT_FILE

# Set the working directory inside the container
WORKDIR /

# Copy the current directory into the container
COPY ./src /exp_agent
COPY ./benchmark /benchmark
COPY ./starter_file /starter_file
COPY ./eval_metadata /eval_metadata

# Install dependencies from the Conda environment file
RUN pip install -U "autogen-agentchat" "autogen-ext[openai]" 

RUN pip install uv playwright

RUN cd /starter_file/autogen/python && \
    uv sync --all-extras && \
    /starter_file/autogen/python/.venv/bin/pip install -e packages/autogen-magentic-one

# Setup OpenAI credentials: this is currently useful for LLM reasoning 2
RUN chmod +x /exp_agent/setup/env.sh
RUN . /exp_agent/setup/env.sh

# Ensure environment variables and virtual environment are set for all sessions
RUN echo "export PROMPT_FILE=${PROMPT_FILE}" >> ~/.bashrc && \
    echo "source /starter_file/autogen/python/.venv/bin/activate" >> ~/.bashrc && \
    echo "source /exp_agent/setup/env.sh" >> ~/.bashrc

# Update the package list and install vim
RUN apt-get update && apt-get install -y vim

RUN mkdir -p /workspace
RUN mkdir -p /temp/logs/

ENV PROMPT_FILE=${PROMPT_FILE}

# # We purposely trigger this so that we can install playwright next..
# RUN cd /starter_file/autogen/python && \
#     source .venv/bin/activate && \
#     python packages/autogen-magentic-one/examples/example.py --logs_dir /temp/logs/ || true

RUN playwright install && \
    playwright install-deps

# Ensure bash is the default shell
SHELL ["/bin/bash", "-c"]

# Default command
# CMD ["bash"]
# Keep container running
CMD ["tail", "-f", "/dev/null"]